# Azure Workload Identity: binds the Kubernetes ServiceAccount to an Azure Managed Identity.
# The identity-service pod uses this SA to authenticate to Azure Key Vault at runtime —
# no credentials are stored in the container image or Kubernetes Secrets.
#
# Setup steps (run once after AKS cluster creation):
#   1. Enable Workload Identity on AKS:
#      az aks update --resource-group <RG> --name <CLUSTER> --enable-oidc-issuer --enable-workload-identity
#
#   2. Create an Azure Managed Identity:
#      az identity create --resource-group <RG> --name identity-service-mid
#
#   3. Assign Key Vault access:
#      az keyvault set-policy --name watup-keyvault \
#        --object-id $(az identity show --name identity-service-mid --query principalId -o tsv) \
#        --secret-permissions get list
#
#   4. Federate the Kubernetes SA with the Managed Identity:
#      az identity federated-credential create \
#        --name identity-service-fed \
#        --identity-name identity-service-mid \
#        --resource-group <RG> \
#        --issuer $(az aks show --name <CLUSTER> --resource-group <RG> --query oidcIssuerProfile.issuerUrl -o tsv) \
#        --subject system:serviceaccount:app:identity-service-sa
#
#   5. Apply this manifest — kubectl apply -f k8s/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: identity-service-sa
  namespace: app
  annotations:
    # Replace with the actual Client ID of your Managed Identity
    azure.workload.identity/client-id: "00000000-0000-0000-0000-000000000000"
  labels:
    azure.workload.identity/use: "true"
